// Compass Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// MAIN MODELS
// ============================================================================

// Tasks Database
model Task {
  id               String     @id @default(uuid())
  name             String
  status           TaskStatus
  priority         Priority
  categoryId       String
  category         Category   @relation(fields: [categoryId], references: [id])
  context          Context
  energyRequired   Energy
  duration         Int // minutes
  definitionOfDone String
  dueDate          DateTime?
  scheduledStart   DateTime?
  activatedAt      DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  postDoLog PostDoLog?

  @@index([status, priority])
  @@index([scheduledStart])
  @@index([categoryId])
  @@index([createdAt])
  @@index([dueDate])
  @@index([status, scheduledStart])
  @@index([status, priority, scheduledStart]) // Optimize main task list query
  @@index([status, priority, scheduledStart, createdAt]) // Optimize default sort with createdAt tiebreaker (BACKEND-PERF-001)
}

model Category {
  id             String   @id @default(uuid())
  name           String
  nameKey        String   @unique
  color          String
  icon           String
  togglProjectId String?
  isSystem       Boolean  @default(false)
  isLocked       Boolean  @default(false)
  isArchived     Boolean  @default(false)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tasks          Task[]

  @@index([isArchived])
  @@index([isArchived, sortOrder])
}

// Orient Database (Daily Plans)
model DailyPlan {
  id   String   @id @default(uuid())
  date DateTime @unique

  // Orient East (Morning)
  energyLevel    Energy
  plannedBlocks  Json @default("[]") // [{ id, start, end, label }]
  topOutcomes    String[] // Max 3
  reward         String?

  // Orient West (Evening)
  reflection     String?
  actualOutcomes Int? // 0-3
  energyMatch    EnergyMatch?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

// Post-Do Logs
model PostDoLog {
  id     String @id @default(uuid())
  taskId String @unique
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  outcome     String
  effortLevel Effort
  keyInsight  String

  estimatedDuration Int // minutes
  actualDuration    Int // minutes
  variance          Int // calculated: actualDuration - estimatedDuration
  efficiency        Float // calculated: (estimatedDuration / actualDuration) * 100

  startTime DateTime
  endTime   DateTime
  timeOfDay TimeOfDay // calculated
  dayOfWeek String // calculated

  timeryEntryId String?
  evidenceLink  String?
  rewardTaken   Boolean @default(false)

  completionDate DateTime @default(now())

  @@index([completionDate])
  @@index([timeOfDay])
  @@index([taskId])
  @@index([completionDate, taskId]) // Optimize date range queries with task joins
}

// Reviews Database
model Review {
  id          String     @id @default(uuid())
  type        ReviewType // DAILY or WEEKLY
  periodStart DateTime
  periodEnd   DateTime

  // 3-3-3 Reflections
  wins      String[] // Max 3
  misses    String[] // Max 3
  lessons   String[] // Max 3
  nextGoals String[] // Max 3

  // Performance Metrics
  executionRate   Float?
  tasksCompleted  Int
  deepWorkHours   Float
  categoryBalance Json // {category: minutes}
  activityBreakdown Json? // {activity: minutes} - Time Engine PRIMARY

  // Time Metrics
  totalTrackedTime Int // minutes
  timeCoverage     Float // percentage
  contextSwitches  Int?

  // Energy
  energyAssessment Energy?

  // Future: Biometric
  sleepScore    Int?
  vitalsScore   Int?
  activityScore Int?

  createdAt DateTime @default(now())

  @@index([periodStart, type])
  @@index([type])
  @@unique([type, periodStart], name: "unique_review_per_period")
}

// Temporary Captured Tasks (from Todoist)
model TempCapturedTask {
  id        String    @id @default(uuid())
  name      String
  dueDate   DateTime?
  source    String    @default("TODOIST")
  processed Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([processed])
}

// Time Engine - Tracks time independently of tasks
model TimeSlice {
  id           String        @id @default(uuid())
  start        DateTime
  end          DateTime?
  category     String
  dimension    TimeDimension
  source       TimeSource
  isLocked     Boolean       @default(false)
  linkedTaskId String?
  togglEntryId String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([start, end])
  @@index([dimension, end])
}

// Health Metrics - Daily aggregate data from HealthKit
model DailyHealthMetric {
  id             String   @id @default(uuid())
  date           DateTime @unique

  // Activity
  steps          Int?
  activeCalories Int?
  exerciseMinutes Int?
  standHours     Int?

  // Sleep Quality (from HealthKit analysis)
  sleepDuration  Int?     // minutes
  sleepQuality   String?  // POOR, FAIR, GOOD, EXCELLENT

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ============================================================================
// ENUMS
// ============================================================================

enum TaskStatus {
  NEXT
  WAITING
  ACTIVE
  DONE
  SOMEDAY
}

enum Priority {
  MUST // 1
  SHOULD // 2
  COULD // 3
  MAYBE // 4
}

enum Context {
  HOME
  OFFICE
  COMPUTER
  PHONE
  ERRANDS
  ANYWHERE
}

enum Energy {
  HIGH
  MEDIUM
  LOW
}

enum Effort {
  SMALL
  MEDIUM
  LARGE
}

enum TimeOfDay {
  EARLY_MORNING // 5-8am
  MORNING // 8-11am
  MIDDAY // 11am-2pm
  AFTERNOON // 2-5pm
  EVENING // 5-8pm
  NIGHT // 8pm+
}

enum EnergyMatch {
  PERFECT
  MOSTLY_ALIGNED
  SOME_MISMATCH
  POOR
}

enum ReviewType {
  DAILY
  WEEKLY
}

enum TimeDimension {
  PRIMARY
  WORK_MODE
  SOCIAL
  SEGMENT
}

enum TimeSource {
  SHORTCUT
  TIMERY
  MANUAL
  API
}
