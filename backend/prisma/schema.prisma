// Compass Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MAIN MODELS
// ============================================================================

// Tasks Database
model Task {
  id                String       @id @default(uuid())
  name              String
  status            TaskStatus
  priority          Priority
  category          Category
  context           Context
  energyRequired    Energy
  duration          Int          // minutes
  definitionOfDone  String
  dueDate           DateTime?
  scheduledStart    DateTime?
  activatedAt       DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  postDoLog         PostDoLog?

  @@index([status, priority])
  @@index([scheduledStart])
  @@index([category])
}

// Orient Database (Daily Plans)
model DailyPlan {
  id                String       @id @default(uuid())
  date              DateTime     @unique

  // Orient East (Morning)
  energyLevel       Energy
  deepWorkBlock1    Json         // {start, end, focus}
  deepWorkBlock2    Json?
  adminBlock        Json?
  bufferBlock       Json?
  topOutcomes       String[]     // Max 3
  reward            String?

  // Orient West (Evening)
  reflection        String?
  actualOutcomes    Int?         // 0-3
  energyMatch       EnergyMatch?

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([date])
}

// Post-Do Logs
model PostDoLog {
  id                String       @id @default(uuid())
  taskId            String       @unique
  task              Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)

  outcome           String
  effortLevel       Effort
  keyInsight        String

  estimatedDuration Int          // minutes
  actualDuration    Int          // minutes
  variance          Int          // calculated: actualDuration - estimatedDuration
  efficiency        Float        // calculated: (estimatedDuration / actualDuration) * 100

  startTime         DateTime
  endTime           DateTime
  timeOfDay         TimeOfDay    // calculated
  dayOfWeek         String       // calculated

  timeryEntryId     String?
  evidenceLink      String?
  rewardTaken       Boolean      @default(false)

  completionDate    DateTime     @default(now())

  @@index([completionDate])
  @@index([timeOfDay])
}

// Reviews Database
model Review {
  id                String       @id @default(uuid())
  type              ReviewType   // DAILY or WEEKLY
  periodStart       DateTime
  periodEnd         DateTime

  // 3-3-3 Reflections
  wins              String[]     // Max 3
  misses            String[]     // Max 3
  lessons           String[]     // Max 3
  nextGoals         String[]     // Max 3

  // Performance Metrics
  executionRate     Float?
  tasksCompleted    Int
  deepWorkHours     Float
  categoryBalance   Json         // {category: minutes}

  // Time Metrics
  totalTrackedTime  Int          // minutes
  timeCoverage      Float        // percentage
  contextSwitches   Int?

  // Energy
  energyAssessment  Energy?

  // Future: Biometric
  sleepScore        Int?
  vitalsScore       Int?
  activityScore     Int?

  createdAt         DateTime     @default(now())

  @@index([periodStart, type])
  @@index([type])
}

// Temporary Captured Tasks (from Todoist)
model TempCapturedTask {
  id         String    @id @default(uuid())
  name       String
  dueDate    DateTime?
  source     String    @default("TODOIST")
  processed  Boolean   @default(false)
  createdAt  DateTime  @default(now())

  @@index([processed])
}

// ============================================================================
// ENUMS
// ============================================================================

enum TaskStatus {
  NEXT
  WAITING
  ACTIVE
  DONE
  SOMEDAY
}

enum Priority {
  MUST      // 1
  SHOULD    // 2
  COULD     // 3
  MAYBE     // 4
}

enum Category {
  SCHOOL
  MUSIC
  FITNESS
  GAMING
  NUTRITION
  HYGIENE
  PET
  SOCIAL
  PERSONAL
  ADMIN
}

enum Context {
  HOME
  OFFICE
  COMPUTER
  PHONE
  ERRANDS
  ANYWHERE
}

enum Energy {
  HIGH
  MEDIUM
  LOW
}

enum Effort {
  SMALL
  MEDIUM
  LARGE
}

enum TimeOfDay {
  EARLY_MORNING   // 5-8am
  MORNING         // 8-11am
  MIDDAY          // 11am-2pm
  AFTERNOON       // 2-5pm
  EVENING         // 5-8pm
  NIGHT           // 8pm+
}

enum EnergyMatch {
  PERFECT
  MOSTLY_ALIGNED
  SOME_MISMATCH
  POOR
}

enum ReviewType {
  DAILY
  WEEKLY
}
